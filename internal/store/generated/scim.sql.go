// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: scim.sql

package generated

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const countSCIMGroupMappings = `-- name: CountSCIMGroupMappings :one
SELECT count(*) FROM scim_group_mapping_projection
WHERE provider_id = $1
`

func (q *Queries) CountSCIMGroupMappings(ctx context.Context, providerID string) (int64, error) {
	row := q.db.QueryRow(ctx, countSCIMGroupMappings, providerID)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const countSCIMUsers = `-- name: CountSCIMUsers :one
SELECT count(*) FROM users_projection u
JOIN identity_links_projection il ON il.user_id = u.id
WHERE il.provider_id = $1 AND u.is_deleted = FALSE
`

func (q *Queries) CountSCIMUsers(ctx context.Context, providerID string) (int64, error) {
	row := q.db.QueryRow(ctx, countSCIMUsers, providerID)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const findSCIMUserByEmail = `-- name: FindSCIMUserByEmail :one
SELECT u.id, u.email, u.password_hash, u.role, u.created_at, u.updated_at, u.last_login_at, u.disabled, u.is_deleted, u.projection_version, u.session_version, u.totp_enabled, u.has_password, il.external_id AS scim_external_id
FROM users_projection u
JOIN identity_links_projection il ON il.user_id = u.id
WHERE il.provider_id = $1 AND u.email = $2 AND u.is_deleted = FALSE
`

type FindSCIMUserByEmailParams struct {
	ProviderID string `json:"provider_id"`
	Email      string `json:"email"`
}

type FindSCIMUserByEmailRow struct {
	ID                string             `json:"id"`
	Email             string             `json:"email"`
	PasswordHash      *string            `json:"password_hash"`
	Role              string             `json:"role"`
	CreatedAt         pgtype.Timestamptz `json:"created_at"`
	UpdatedAt         pgtype.Timestamptz `json:"updated_at"`
	LastLoginAt       pgtype.Timestamptz `json:"last_login_at"`
	Disabled          bool               `json:"disabled"`
	IsDeleted         bool               `json:"is_deleted"`
	ProjectionVersion int64              `json:"projection_version"`
	SessionVersion    int32              `json:"session_version"`
	TotpEnabled       bool               `json:"totp_enabled"`
	HasPassword       bool               `json:"has_password"`
	ScimExternalID    string             `json:"scim_external_id"`
}

func (q *Queries) FindSCIMUserByEmail(ctx context.Context, arg FindSCIMUserByEmailParams) (FindSCIMUserByEmailRow, error) {
	row := q.db.QueryRow(ctx, findSCIMUserByEmail, arg.ProviderID, arg.Email)
	var i FindSCIMUserByEmailRow
	err := row.Scan(
		&i.ID,
		&i.Email,
		&i.PasswordHash,
		&i.Role,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.LastLoginAt,
		&i.Disabled,
		&i.IsDeleted,
		&i.ProjectionVersion,
		&i.SessionVersion,
		&i.TotpEnabled,
		&i.HasPassword,
		&i.ScimExternalID,
	)
	return i, err
}

const findSCIMUserByExternalID = `-- name: FindSCIMUserByExternalID :one
SELECT u.id, u.email, u.password_hash, u.role, u.created_at, u.updated_at, u.last_login_at, u.disabled, u.is_deleted, u.projection_version, u.session_version, u.totp_enabled, u.has_password, il.external_id AS scim_external_id
FROM users_projection u
JOIN identity_links_projection il ON il.user_id = u.id
WHERE il.provider_id = $1 AND il.external_id = $2 AND u.is_deleted = FALSE
`

type FindSCIMUserByExternalIDParams struct {
	ProviderID string `json:"provider_id"`
	ExternalID string `json:"external_id"`
}

type FindSCIMUserByExternalIDRow struct {
	ID                string             `json:"id"`
	Email             string             `json:"email"`
	PasswordHash      *string            `json:"password_hash"`
	Role              string             `json:"role"`
	CreatedAt         pgtype.Timestamptz `json:"created_at"`
	UpdatedAt         pgtype.Timestamptz `json:"updated_at"`
	LastLoginAt       pgtype.Timestamptz `json:"last_login_at"`
	Disabled          bool               `json:"disabled"`
	IsDeleted         bool               `json:"is_deleted"`
	ProjectionVersion int64              `json:"projection_version"`
	SessionVersion    int32              `json:"session_version"`
	TotpEnabled       bool               `json:"totp_enabled"`
	HasPassword       bool               `json:"has_password"`
	ScimExternalID    string             `json:"scim_external_id"`
}

func (q *Queries) FindSCIMUserByExternalID(ctx context.Context, arg FindSCIMUserByExternalIDParams) (FindSCIMUserByExternalIDRow, error) {
	row := q.db.QueryRow(ctx, findSCIMUserByExternalID, arg.ProviderID, arg.ExternalID)
	var i FindSCIMUserByExternalIDRow
	err := row.Scan(
		&i.ID,
		&i.Email,
		&i.PasswordHash,
		&i.Role,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.LastLoginAt,
		&i.Disabled,
		&i.IsDeleted,
		&i.ProjectionVersion,
		&i.SessionVersion,
		&i.TotpEnabled,
		&i.HasPassword,
		&i.ScimExternalID,
	)
	return i, err
}

const getIdentityProviderBySlugForSCIM = `-- name: GetIdentityProviderBySlugForSCIM :one
SELECT id, name, slug, provider_type, enabled, client_id, client_secret_encrypted, issuer_url, authorization_url, token_url, userinfo_url, scopes, auto_create_users, auto_link_by_email, default_role_id, attribute_mapping, disable_password_for_linked, group_claim, group_mapping, created_at, created_by, updated_at, is_deleted, projection_version, scim_enabled, scim_token_hash FROM identity_providers_projection
WHERE slug = $1 AND is_deleted = FALSE AND scim_enabled = TRUE
`

func (q *Queries) GetIdentityProviderBySlugForSCIM(ctx context.Context, slug string) (IdentityProvidersProjection, error) {
	row := q.db.QueryRow(ctx, getIdentityProviderBySlugForSCIM, slug)
	var i IdentityProvidersProjection
	err := row.Scan(
		&i.ID,
		&i.Name,
		&i.Slug,
		&i.ProviderType,
		&i.Enabled,
		&i.ClientID,
		&i.ClientSecretEncrypted,
		&i.IssuerUrl,
		&i.AuthorizationUrl,
		&i.TokenUrl,
		&i.UserinfoUrl,
		&i.Scopes,
		&i.AutoCreateUsers,
		&i.AutoLinkByEmail,
		&i.DefaultRoleID,
		&i.AttributeMapping,
		&i.DisablePasswordForLinked,
		&i.GroupClaim,
		&i.GroupMapping,
		&i.CreatedAt,
		&i.CreatedBy,
		&i.UpdatedAt,
		&i.IsDeleted,
		&i.ProjectionVersion,
		&i.ScimEnabled,
		&i.ScimTokenHash,
	)
	return i, err
}

const getSCIMGroupMapping = `-- name: GetSCIMGroupMapping :one
SELECT id, provider_id, scim_group_id, scim_display_name, user_group_id, created_at, projection_version FROM scim_group_mapping_projection
WHERE provider_id = $1 AND scim_group_id = $2
`

type GetSCIMGroupMappingParams struct {
	ProviderID  string `json:"provider_id"`
	ScimGroupID string `json:"scim_group_id"`
}

func (q *Queries) GetSCIMGroupMapping(ctx context.Context, arg GetSCIMGroupMappingParams) (ScimGroupMappingProjection, error) {
	row := q.db.QueryRow(ctx, getSCIMGroupMapping, arg.ProviderID, arg.ScimGroupID)
	var i ScimGroupMappingProjection
	err := row.Scan(
		&i.ID,
		&i.ProviderID,
		&i.ScimGroupID,
		&i.ScimDisplayName,
		&i.UserGroupID,
		&i.CreatedAt,
		&i.ProjectionVersion,
	)
	return i, err
}

const getSCIMGroupMappingByUserGroup = `-- name: GetSCIMGroupMappingByUserGroup :one
SELECT id, provider_id, scim_group_id, scim_display_name, user_group_id, created_at, projection_version FROM scim_group_mapping_projection
WHERE provider_id = $1 AND user_group_id = $2
`

type GetSCIMGroupMappingByUserGroupParams struct {
	ProviderID  string `json:"provider_id"`
	UserGroupID string `json:"user_group_id"`
}

func (q *Queries) GetSCIMGroupMappingByUserGroup(ctx context.Context, arg GetSCIMGroupMappingByUserGroupParams) (ScimGroupMappingProjection, error) {
	row := q.db.QueryRow(ctx, getSCIMGroupMappingByUserGroup, arg.ProviderID, arg.UserGroupID)
	var i ScimGroupMappingProjection
	err := row.Scan(
		&i.ID,
		&i.ProviderID,
		&i.ScimGroupID,
		&i.ScimDisplayName,
		&i.UserGroupID,
		&i.CreatedAt,
		&i.ProjectionVersion,
	)
	return i, err
}

const getUserByExternalSCIMID = `-- name: GetUserByExternalSCIMID :one
SELECT u.id, u.email, u.password_hash, u.role, u.created_at, u.updated_at, u.last_login_at, u.disabled, u.is_deleted, u.projection_version, u.session_version, u.totp_enabled, u.has_password FROM users_projection u
JOIN identity_links_projection il ON il.user_id = u.id
WHERE il.provider_id = $1 AND il.external_id = $2 AND u.is_deleted = FALSE
`

type GetUserByExternalSCIMIDParams struct {
	ProviderID string `json:"provider_id"`
	ExternalID string `json:"external_id"`
}

func (q *Queries) GetUserByExternalSCIMID(ctx context.Context, arg GetUserByExternalSCIMIDParams) (UsersProjection, error) {
	row := q.db.QueryRow(ctx, getUserByExternalSCIMID, arg.ProviderID, arg.ExternalID)
	var i UsersProjection
	err := row.Scan(
		&i.ID,
		&i.Email,
		&i.PasswordHash,
		&i.Role,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.LastLoginAt,
		&i.Disabled,
		&i.IsDeleted,
		&i.ProjectionVersion,
		&i.SessionVersion,
		&i.TotpEnabled,
		&i.HasPassword,
	)
	return i, err
}

const getUserGroupWithMembers = `-- name: GetUserGroupWithMembers :one
SELECT ug.id, ug.name, ug.description, ug.member_count, ug.created_at, ug.created_by, ug.updated_at, ug.is_deleted, ug.projection_version, (
    SELECT count(*) FROM user_group_members_projection ugm
    WHERE ugm.group_id = ug.id
) AS actual_member_count
FROM user_groups_projection ug
WHERE ug.id = $1 AND ug.is_deleted = FALSE
`

type GetUserGroupWithMembersRow struct {
	ID                string             `json:"id"`
	Name              string             `json:"name"`
	Description       string             `json:"description"`
	MemberCount       int32              `json:"member_count"`
	CreatedAt         pgtype.Timestamptz `json:"created_at"`
	CreatedBy         string             `json:"created_by"`
	UpdatedAt         pgtype.Timestamptz `json:"updated_at"`
	IsDeleted         bool               `json:"is_deleted"`
	ProjectionVersion int64              `json:"projection_version"`
	ActualMemberCount int64              `json:"actual_member_count"`
}

func (q *Queries) GetUserGroupWithMembers(ctx context.Context, id string) (GetUserGroupWithMembersRow, error) {
	row := q.db.QueryRow(ctx, getUserGroupWithMembers, id)
	var i GetUserGroupWithMembersRow
	err := row.Scan(
		&i.ID,
		&i.Name,
		&i.Description,
		&i.MemberCount,
		&i.CreatedAt,
		&i.CreatedBy,
		&i.UpdatedAt,
		&i.IsDeleted,
		&i.ProjectionVersion,
		&i.ActualMemberCount,
	)
	return i, err
}

const listSCIMGroupMappings = `-- name: ListSCIMGroupMappings :many
SELECT sgm.id, sgm.provider_id, sgm.scim_group_id, sgm.scim_display_name, sgm.user_group_id, sgm.created_at, sgm.projection_version
FROM scim_group_mapping_projection sgm
WHERE sgm.provider_id = $1
ORDER BY sgm.scim_display_name
`

func (q *Queries) ListSCIMGroupMappings(ctx context.Context, providerID string) ([]ScimGroupMappingProjection, error) {
	rows, err := q.db.Query(ctx, listSCIMGroupMappings, providerID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []ScimGroupMappingProjection{}
	for rows.Next() {
		var i ScimGroupMappingProjection
		if err := rows.Scan(
			&i.ID,
			&i.ProviderID,
			&i.ScimGroupID,
			&i.ScimDisplayName,
			&i.UserGroupID,
			&i.CreatedAt,
			&i.ProjectionVersion,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listSCIMUsers = `-- name: ListSCIMUsers :many
SELECT u.id, u.email, u.password_hash, u.role, u.created_at, u.updated_at, u.last_login_at, u.disabled, u.is_deleted, u.projection_version, u.session_version, u.totp_enabled, u.has_password, il.external_id AS scim_external_id
FROM users_projection u
JOIN identity_links_projection il ON il.user_id = u.id
WHERE il.provider_id = $1 AND u.is_deleted = FALSE
ORDER BY u.created_at DESC
LIMIT $2 OFFSET $3
`

type ListSCIMUsersParams struct {
	ProviderID string `json:"provider_id"`
	Limit      int32  `json:"limit"`
	Offset     int32  `json:"offset"`
}

type ListSCIMUsersRow struct {
	ID                string             `json:"id"`
	Email             string             `json:"email"`
	PasswordHash      *string            `json:"password_hash"`
	Role              string             `json:"role"`
	CreatedAt         pgtype.Timestamptz `json:"created_at"`
	UpdatedAt         pgtype.Timestamptz `json:"updated_at"`
	LastLoginAt       pgtype.Timestamptz `json:"last_login_at"`
	Disabled          bool               `json:"disabled"`
	IsDeleted         bool               `json:"is_deleted"`
	ProjectionVersion int64              `json:"projection_version"`
	SessionVersion    int32              `json:"session_version"`
	TotpEnabled       bool               `json:"totp_enabled"`
	HasPassword       bool               `json:"has_password"`
	ScimExternalID    string             `json:"scim_external_id"`
}

func (q *Queries) ListSCIMUsers(ctx context.Context, arg ListSCIMUsersParams) ([]ListSCIMUsersRow, error) {
	rows, err := q.db.Query(ctx, listSCIMUsers, arg.ProviderID, arg.Limit, arg.Offset)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []ListSCIMUsersRow{}
	for rows.Next() {
		var i ListSCIMUsersRow
		if err := rows.Scan(
			&i.ID,
			&i.Email,
			&i.PasswordHash,
			&i.Role,
			&i.CreatedAt,
			&i.UpdatedAt,
			&i.LastLoginAt,
			&i.Disabled,
			&i.IsDeleted,
			&i.ProjectionVersion,
			&i.SessionVersion,
			&i.TotpEnabled,
			&i.HasPassword,
			&i.ScimExternalID,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}
